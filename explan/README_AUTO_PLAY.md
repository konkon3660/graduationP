# 🎮 자동 놀이 기능 (Auto Play Service)

## 개요

자동 놀이 기능은 클라이언트 연결이 종료된 후 일정 시간이 지나면 자동으로 레이저포인터를 움직이면서 반려동물과 놀아주는 기능입니다. 

## 🎯 주요 기능

### 1. 자동 활성화
- 모든 클라이언트 연결이 종료된 후 설정된 시간(기본 70초)이 지나면 자동으로 시작
- 클라이언트가 다시 연결되면 즉시 중지

### 2. 다양한 놀이 패턴
- **원 그리기 (Circle Pattern)**: 랜덤한 크기의 원을 그리며 움직임
- **8자 그리기 (Figure Eight)**: 8자 모양을 그리며 움직임
- **랜덤 움직임 (Random Movement)**: 부드러운 랜덤 움직임
- **파도 패턴 (Wave Pattern)**: 사인파를 따라 움직임
- **나선 패턴 (Spiral Pattern)**: 나선형으로 확장하며 움직임
- **지그재그 패턴 (Zigzag Pattern)**: 지그재그 모양으로 움직임
- **하트 패턴 (Heart Pattern)**: 하트 모양을 그리며 움직임

### 3. 설정 가능한 대기 시간
- 10초 ~ 300초 범위에서 자동 놀이 시작 대기 시간 설정 가능
- 실시간으로 설정 변경 가능

## 🔧 하드웨어 요구사항

### 필수 구성 요소
- **X축 서보모터**: GPIO 19 (좌우 움직임)
- **Y축 서보모터**: GPIO 13 (상하 움직임)
- **레이저 포인터**: GPIO 17

### 서보모터 사양
- **각도 범위**: 0° ~ 180°
- **PWM 주파수**: 50Hz
- **중앙 위치**: X=90°, Y=90°

## 📋 사용법

### 1. 웹 인터페이스 사용
```
http://your-raspberry-pi-ip:8000/Exam/test_auto_play.html
```

### 2. WebSocket API 사용

#### 연결
```javascript
const ws = new WebSocket('ws://your-raspberry-pi-ip:8000/ws/settings');
```

#### 자동 놀이 상태 조회
```javascript
ws.send(JSON.stringify({
    type: 'get_auto_play_status'
}));
```

#### 대기 시간 설정
```javascript
ws.send(JSON.stringify({
    type: 'set_auto_play_delay',
    delay: 120  // 120초로 설정
}));
```

### 3. 응답 메시지 형식

#### 자동 놀이 상태
```json
{
    "type": "auto_play_status",
    "auto_play_status": {
        "connected_clients": 0,
        "is_auto_playing": false,
        "auto_play_delay": 70,
        "auto_play_running": false
    },
    "success": true
}
```

#### 대기 시간 업데이트
```json
{
    "type": "auto_play_delay_updated",
    "delay": 120,
    "success": true
}
```

## ⚙️ 설정

### 기본 설정
- **자동 놀이 대기 시간**: 70초
- **패턴 간 대기 시간**: 2~5초 (랜덤)
- **서보모터 움직임 속도**: 0.05초 간격

### 설정 변경 방법

#### 1. 웹 인터페이스
1. 자동 놀이 테스트 페이지 접속
2. "자동 놀이 시작 대기 시간" 입력
3. "설정 변경" 버튼 클릭

#### 2. 코드에서 직접 설정
```python
from services.auto_play_service import auto_play_service

# 대기 시간을 120초로 변경
auto_play_service.set_auto_play_delay(120)
```

## 🔍 동작 원리

### 1. 클라이언트 연결 추적
```python
# 클라이언트 등록
auto_play_service.register_client(websocket)

# 클라이언트 해제
auto_play_service.unregister_client(websocket)
```

### 2. 자동 놀이 스케줄링
```python
# 모든 클라이언트가 연결 해제되면 타이머 시작
if len(self.connected_clients) == 0:
    self.schedule_auto_play()
```

### 3. 패턴 실행
```python
# 랜덤하게 패턴 선택하여 실행
pattern = random.choice(patterns)
await pattern()
```

## 🎨 놀이 패턴 상세

### 원 그리기 패턴
- **수학적 표현**: `x = center_x + radius * cos(angle)`, `y = center_y + radius * sin(angle)`
- **반지름**: 20~40 (랜덤)
- **각도 간격**: 8도

### 8자 그리기 패턴
- 두 개의 원을 연결하여 8자 모양 생성
- 위쪽 원과 아래쪽 원을 순차적으로 그리기

### 랜덤 움직임 패턴
- 현재 위치에서 목표 위치까지 부드럽게 이동
- 5~15단계로 나누어 부드러운 움직임 구현

### 파도 패턴
- **수학적 표현**: `y = center_y + amplitude * sin(frequency * x)`
- **진폭**: 15~30 (랜덤)
- **주파수**: 0.5~1.5 (랜덤)

### 나선 패턴
- **수학적 표현**: `x = center_x + radius * cos(angle)`, `y = center_y + radius * sin(angle)`
- **반지름**: `radius = i * 0.3` (점진적 증가)
- **각도**: `angle = i * 8` (점진적 증가)

### 지그재그 패턴
- 수평으로 이동하면서 수직 위치를 주기적으로 변경
- 20단위로 수직 위치 변경

### 하트 패턴
- **수학적 표현**: 
  - `x = 16 * sin(t)^3`
  - `y = -(13*cos(t) - 5*cos(2t) - 2*cos(3t) - cos(4t))`
- 하트 방정식을 사용하여 정확한 하트 모양 생성

## 🚨 주의사항

### 1. 안전
- 레이저 포인터 사용 시 반려동물의 눈에 직접 비추지 않도록 주의
- 서보모터의 움직임 범위 내에서만 동작하도록 제한

### 2. 하드웨어 제한
- 서보모터의 각도 범위(0°~180°)를 초과하지 않도록 제한
- 너무 빠른 움직임으로 인한 서보모터 과부하 방지

### 3. 전력 소모
- 지속적인 서보모터 움직임으로 인한 전력 소모 고려
- 배터리 사용 시 충분한 용량 확보

## 🔧 문제 해결

### 1. 자동 놀이가 시작되지 않는 경우
- 클라이언트 연결 상태 확인
- 대기 시간 설정 확인
- 서보모터 초기화 상태 확인

### 2. 서보모터가 움직이지 않는 경우
- GPIO 핀 연결 상태 확인
- 서보모터 전원 공급 상태 확인
- PWM 설정 확인

### 3. 레이저가 켜지지 않는 경우
- 레이저 모듈 전원 공급 확인
- GPIO 17 핀 연결 상태 확인

## 📝 로그 메시지

### 일반 로그
```
🎮 자동 놀이 서비스 초기화 (대기시간: 70초)
👤 클라이언트 등록됨 (총 1명)
👤 클라이언트 해제됨 (총 0명)
⏰ 70초 후 자동 놀이 시작 예정
```

### 패턴 실행 로그
```
🎮 자동 놀이 시작!
🔴 레이저 포인터 켜짐
⭕ 원 그리기 패턴 시작
8️⃣ 8자 그리기 패턴 시작
🎲 랜덤 움직임 패턴 시작
🌊 파도 패턴 시작
🌀 나선 패턴 시작
⚡ 지그재그 패턴 시작
💖 하트 패턴 시작
```

### 오류 로그
```
❌ 자동 놀이 스케줄링 오류: [오류 내용]
❌ 자동 놀이 중 오류: [오류 내용]
⏹ 자동 놀이 스케줄 취소됨
```

## 🔄 향후 개선 계획

### 1. 패턴 확장
- 더 복잡한 기하학적 패턴 추가
- 사용자 정의 패턴 지원
- 패턴 조합 기능

### 2. 지능형 기능
- 반려동물 움직임 감지 (초음파 센서 활용)
- 반응형 놀이 패턴
- 학습 기반 패턴 최적화

### 3. 설정 확장
- 개별 패턴 활성화/비활성화
- 패턴별 속도 조절
- 시간대별 자동 놀이 설정

## 📞 지원

자동 놀이 기능과 관련된 문제나 개선 제안이 있으시면 이슈를 등록해 주세요. 