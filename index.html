<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ë¡œë´‡ ë””ìŠ¤í”Œë ˆì´</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* ì–¼êµ´ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        .face {
            position: relative;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, #ffdbac, #f1c27d);
            border-radius: 50%;
            box-shadow: 
                0 10px 30px rgba(0,0,0,0.3),
                inset 0 -10px 20px rgba(0,0,0,0.1);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        /* ëˆˆ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        .eyes {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 60px;
        }

        .eye {
            position: relative;
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .pupil {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 25px;
            height: 25px;
            background: radial-gradient(circle, #2c3e50, #34495e);
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .eyelid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, #ffdbac, #f1c27d);
            border-radius: 50%;
            transform: scaleY(0);
            transform-origin: top;
            transition: transform 0.3s ease;
        }

        /* ì… ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        .mouth {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 40px;
            background: #e74c3c;
            border-radius: 0 0 40px 40px;
            transition: all 0.3s ease;
        }

        /* í–‰ë³µí•œ í‘œì • */
        .face.happy {
            transform: scale(1);
        }

        .face.happy .pupil {
            background: radial-gradient(circle, #27ae60, #2ecc71);
        }

        .face.happy .mouth {
            width: 100px;
            height: 50px;
            background: #e74c3c;
            border-radius: 0 0 50px 50px;
            transform: translateX(-50%) scaleY(1.2);
        }

        /* ìë™ ë†€ì´ ì¤‘ í‘œì • */
        .face.auto-playing {
            animation: bounce 2s infinite;
        }

        .face.auto-playing .pupil {
            background: radial-gradient(circle, #f39c12, #e67e22);
            animation: blink 3s infinite;
        }

        .face.auto-playing .mouth {
            width: 90px;
            height: 45px;
            background: #e67e22;
            border-radius: 0 0 45px 45px;
            animation: smile 2s infinite;
        }

        /* ë†€ë€ í‘œì • */
        .face.surprised {
            transform: scale(1.1);
        }

        .face.surprised .eye {
            transform: scaleY(1.3);
        }

        .face.surprised .pupil {
            background: radial-gradient(circle, #e74c3c, #c0392b);
            transform: translate(-50%, -50%) scale(1.2);
        }

        .face.surprised .mouth {
            width: 60px;
            height: 60px;
            background: #e74c3c;
            border-radius: 50%;
            transform: translateX(-50%);
        }

        /* ìŠ¬í”ˆ í‘œì • */
        .face.sad {
            transform: scale(0.95);
        }

        .face.sad .eye {
            transform: rotate(-5deg);
        }

        .face.sad .pupil {
            background: radial-gradient(circle, #3498db, #2980b9);
        }

        .face.sad .mouth {
            width: 80px;
            height: 20px;
            background: #3498db;
            border-radius: 20px 20px 0 0;
            transform: translateX(-50%) translateY(10px);
        }

        /* í˜¸ê¸°ì‹¬ ë§ì€ í‘œì • */
        .face.curious {
            transform: scale(1.05);
        }

        .face.curious .eye {
            transform: scaleY(1.1);
        }

        .face.curious .pupil {
            background: radial-gradient(circle, #9b59b6, #8e44ad);
            animation: look-around 4s infinite;
        }

        .face.curious .mouth {
            width: 70px;
            height: 30px;
            background: #9b59b6;
            border-radius: 15px;
            transform: translateX(-50%);
        }

        /* ì• ë‹ˆë©”ì´ì…˜ ì •ì˜ */
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        @keyframes blink {
            0%, 90%, 100% { transform: translate(-50%, -50%) scaleY(1); }
            95% { transform: translate(-50%, -50%) scaleY(0.1); }
        }

        @keyframes smile {
            0%, 100% { transform: translateX(-50%) scaleY(1.2); }
            50% { transform: translateX(-50%) scaleY(1.4); }
        }

        @keyframes look-around {
            0%, 100% { transform: translate(-50%, -50%); }
            25% { transform: translate(-30%, -50%); }
            50% { transform: translate(-50%, -30%); }
            75% { transform: translate(-70%, -50%); }
        }

        /* ìƒíƒœ í‘œì‹œ */
        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .status-indicator.connected {
            border-left: 5px solid #27ae60;
            background: rgba(39, 174, 96, 0.1);
        }

        .status-indicator.disconnected {
            border-left: 5px solid #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .status-indicator.connecting {
            border-left: 5px solid #f39c12;
            background: rgba(243, 156, 18, 0.1);
            animation: pulse 1.5s infinite;
        }

        .status-indicator.auto-playing {
            border-left: 5px solid #f39c12;
            background: rgba(243, 156, 18, 0.1);
            animation: glow 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); }
            50% { box-shadow: 0 4px 30px rgba(243, 156, 18, 0.3); }
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .face {
                width: 250px;
                height: 250px;
            }
            
            .eyes {
                top: 70px;
                gap: 50px;
            }
            
            .eye {
                width: 50px;
                height: 50px;
            }
            
            .pupil {
                width: 20px;
                height: 20px;
            }
            
            .mouth {
                bottom: 70px;
                width: 70px;
                height: 35px;
            }
        }
    </style>
</head>

<body>
    <div id="face" class="face happy">
        <div class="eyes">
            <div class="eye">
                <div class="eyelid"></div>
                <div class="pupil"></div>
            </div>
            <div class="eye">
                <div class="eyelid"></div>
                <div class="pupil"></div>
            </div>
        </div>
        <div class="mouth"></div>
    </div>

    <div id="statusIndicator" class="status-indicator disconnected">
        ğŸ”Œ ì—°ê²°ë˜ì§€ ì•ŠìŒ
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let ws = null;
        let isConnected = false;
        let currentState = 'happy';
        let autoPlayStatus = null;
        let reconnectTimer = null;

        // WebSocket ê´€ë¦¬ í´ë˜ìŠ¤
        class WebSocketManager {
            constructor() {
                this.ws = null;
                this.isConnected = false;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectDelay = 3000;
            }

            connect() {
                try {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const host = window.location.host;
                    const wsUrl = `${protocol}//${host}/ws`;
                    
                    console.log('WebSocket ì—°ê²° ì‹œë„:', wsUrl);
                    updateStatusIndicator('connecting', 'ğŸ”„ ì—°ê²° ì¤‘...');
                    
                    this.ws = new WebSocket(wsUrl);
                    this.setupEventHandlers();
                    
                } catch (error) {
                    console.error('WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
                    updateStatusIndicator('disconnected', 'âŒ ì—°ê²° ì‹¤íŒ¨');
                }
            }

            setupEventHandlers() {
                this.ws.onopen = () => {
                    this.isConnected = true;
                    isConnected = true;
                    ws = this.ws;
                    this.reconnectAttempts = 0;
                    updateStatusIndicator('connected', 'ğŸ”— ì—°ê²°ë¨');
                    console.log('WebSocket ì—°ê²° ì„±ê³µ');
                };

                this.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (e) {
                        console.error('ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:', e);
                    }
                };

                this.ws.onclose = (event) => {
                    this.isConnected = false;
                    isConnected = false;
                    ws = null;
                    updateStatusIndicator('disconnected', 'ğŸ”Œ ì—°ê²° í•´ì œë¨');
                    console.log('WebSocket ì—°ê²° í•´ì œë¨ (ì½”ë“œ:', event.code, 'ì´ìœ :', event.reason, ')');
                    
                    this.handleReconnect();
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocket ì˜¤ë¥˜:', error);
                    updateStatusIndicator('disconnected', 'âŒ ì—°ê²° ì˜¤ë¥˜');
                    
                    if (!this.isConnected) {
                        console.error('WebSocket ì—°ê²° ì‹¤íŒ¨ - ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”');
                    }
                };
            }

            handleReconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    console.log(`ì¬ì—°ê²° ì‹œë„ ${this.reconnectAttempts}/${this.maxReconnectAttempts}`);
                    
                    reconnectTimer = setTimeout(() => {
                        this.connect();
                    }, this.reconnectDelay);
                } else {
                    console.error('ìµœëŒ€ ì¬ì—°ê²° ì‹œë„ íšŸìˆ˜ ì´ˆê³¼');
                    updateStatusIndicator('disconnected', 'âŒ ì—°ê²° ì‹¤íŒ¨ (ì¬ì‹œë„ ì¤‘ë‹¨)');
                }
            }

            disconnect() {
                if (this.ws) {
                    this.ws.close();
                }
                if (reconnectTimer) {
                    clearTimeout(reconnectTimer);
                    reconnectTimer = null;
                }
            }

            send(message) {
                if (this.isConnected && this.ws) {
                    this.ws.send(JSON.stringify(message));
                } else {
                    console.error('WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                }
            }
        }

        // í‘œì • ê´€ë¦¬ í´ë˜ìŠ¤
        class FaceManager {
            constructor() {
                this.face = document.getElementById('face');
                this.currentState = 'happy';
                this.transitionDuration = 500;
            }

            setState(newState) {
                if (this.currentState === newState) return;
                
                console.log('í‘œì • ë³€ê²½:', this.currentState, 'â†’', newState);
                
                // ê¸°ì¡´ í´ë˜ìŠ¤ ì œê±°
                this.face.classList.remove(this.currentState);
                
                // ìƒˆ í´ë˜ìŠ¤ ì¶”ê°€
                this.face.classList.add(newState);
                this.currentState = newState;
                
                // ìƒíƒœë³„ ì¶”ê°€ íš¨ê³¼
                this.applyStateEffects(newState);
            }

            applyStateEffects(state) {
                switch (state) {
                    case 'auto-playing':
                        this.addGlowEffect();
                        break;
                    case 'surprised':
                        this.addShakeEffect();
                        break;
                    case 'sad':
                        this.addDroopEffect();
                        break;
                    default:
                        this.removeEffects();
                }
            }

            addGlowEffect() {
                this.face.style.boxShadow = `
                    0 10px 30px rgba(0,0,0,0.3),
                    inset 0 -10px 20px rgba(0,0,0,0.1),
                    0 0 30px rgba(243, 156, 18, 0.5)
                `;
            }

            addShakeEffect() {
                this.face.style.animation = 'shake 0.5s ease-in-out';
                setTimeout(() => {
                    this.face.style.animation = '';
                }, 500);
            }

            addDroopEffect() {
                this.face.style.transform = 'scale(0.95) rotate(-2deg)';
            }

            removeEffects() {
                this.face.style.boxShadow = '';
                this.face.style.animation = '';
                this.face.style.transform = '';
            }
        }

        // ìƒíƒœ í‘œì‹œ ê´€ë¦¬ í´ë˜ìŠ¤
        class StatusManager {
            constructor() {
                this.indicator = document.getElementById('statusIndicator');
            }

            update(status, message) {
                this.indicator.className = `status-indicator ${status}`;
                this.indicator.textContent = message;
            }
        }

        // ì „ì—­ ì¸ìŠ¤í„´ìŠ¤
        const wsManager = new WebSocketManager();
        const faceManager = new FaceManager();
        const statusManager = new StatusManager();

        // WebSocket ë©”ì‹œì§€ ì²˜ë¦¬
        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'init':
                    if (data.auto_play_status) {
                        autoPlayStatus = data.auto_play_status;
                        updateFaceBasedOnStatus();
                    }
                    break;
                case 'auto_play_status':
                    autoPlayStatus = data.auto_play_status;
                    updateFaceBasedOnStatus();
                    break;
                case 'auto_play_delay_updated':
                    console.log('ìë™ ë†€ì´ ëŒ€ê¸° ì‹œê°„ ì—…ë°ì´íŠ¸:', data.delay);
                    break;
                default:
                    console.log('ìˆ˜ì‹ ëœ ë©”ì‹œì§€:', data.type);
            }
        }

        // ìƒíƒœì— ë”°ë¥¸ í‘œì • ì—…ë°ì´íŠ¸
        function updateFaceBasedOnStatus() {
            if (!autoPlayStatus) {
                faceManager.setState('happy');
                statusManager.update('connected', 'ğŸ”— ì—°ê²°ë¨');
                return;
            }
            
            if (autoPlayStatus.is_auto_playing) {
                faceManager.setState('auto-playing');
                statusManager.update('auto-playing', 'ğŸ® ìë™ ë†€ì´ ì¤‘');
            } else if (autoPlayStatus.connected_clients > 0) {
                faceManager.setState('happy');
                statusManager.update('connected', `ğŸ”— í´ë¼ì´ì–¸íŠ¸ ${autoPlayStatus.connected_clients}ëª… ì—°ê²°ë¨`);
            } else {
                faceManager.setState('curious');
                statusManager.update('connected', `â° ${autoPlayStatus.auto_play_delay}ì´ˆ í›„ ìë™ ë†€ì´ ì˜ˆì •`);
            }
        }

        // ì£¼ê¸°ì ìœ¼ë¡œ ìë™ ë†€ì´ ìƒíƒœ ì¡°íšŒ
        function pollAutoPlayStatus() {
            if (isConnected && ws) {
                wsManager.send({
                    type: 'get_auto_play_status'
                });
            }
        }

        // ì–¼êµ´ í´ë¦­ ì´ë²¤íŠ¸
        function setupFaceClick() {
            const face = document.getElementById('face');
            face.addEventListener('click', () => {
                const states = ['happy', 'surprised', 'curious', 'sad'];
                const currentIndex = states.indexOf(faceManager.currentState);
                const nextIndex = (currentIndex + 1) % states.length;
                faceManager.setState(states[nextIndex]);
            });
        }

        // í˜ì´ì§€ ì´ˆê¸°í™”
        function initialize() {
            console.log('ë¡œë´‡ ë””ìŠ¤í”Œë ˆì´ í˜ì´ì§€ ì´ˆê¸°í™”');
            
            // WebSocket ì—°ê²°
            wsManager.connect();
            
            // ì–¼êµ´ í´ë¦­ ì´ë²¤íŠ¸ ì„¤ì •
            setupFaceClick();
            
            // 5ì´ˆë§ˆë‹¤ ìë™ ë†€ì´ ìƒíƒœ ì¡°íšŒ
            setInterval(pollAutoPlayStatus, 5000);
        }

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
        function cleanup() {
            wsManager.disconnect();
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        window.addEventListener('load', initialize);
        window.addEventListener('beforeunload', cleanup);

        // CSS ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>

</html>